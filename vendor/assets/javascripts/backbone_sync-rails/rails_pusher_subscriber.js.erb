this.BackboneSync = this.BackboneSync || {};

BackboneSync.RailsPusherSubscriber = (function() {
  function RailsPusherSubscriber(collection, options) {
    this.collection = collection;
    this.client = options.client;
    this.channel = options.channel;
    this.subscribe();
  }

  RailsPusherSubscriber.prototype.subscribe = function() {
    var self = this;
    var subchannel = "sync-" + this.channel;
    this.pusherChannel = this.client.subscribe(subchannel);

    this.pusherChannel.bind('update', function (data) { self.update(data); });
    this.pusherChannel.bind('create', function (data) { self.create(data); });
    this.pusherChannel.bind('destroy', function (data) { self.destroy(data); });
  };

  RailsPusherSubscriber.prototype.update = function(params) {
    var self = this;
    return $.each(params, function(id, attributes) {
      var model = self.collection.get(id);
      return model.set(attributes);
    });
  };

  RailsPusherSubscriber.prototype.create = function(params) {
    var self = this;
    return $.each(params, function(id, attributes) {
      var model = new self.collection.model(attributes);
      return self.collection.add(model);
    });
  };

  RailsPusherSubscriber.prototype.destroy = function(params) {
    var self = this;
    return $.each(params, function(id, attributes) {
      var model = self.collection.get(id);
      return self.collection.remove(model);
    });
  };

  return RailsPusherSubscriber;
})();
